<div class="h-full flex flex-col">
@if (draft) {
  <!-- Header -->
  <div class="p-4 border-b border-ui-border-light">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold text-termageddon-gray-dark">
          {{ draft.entry.term.text }}
        </h2>
        <div class="flex items-center space-x-2 mt-1">
          <app-perspective-pill 
            [perspective]="draft.entry.perspective" 
            size="medium"
            variant="selected"
          ></app-perspective-pill>
          @if (draft.entry.is_official) {
            <span class="px-2 py-1 bg-status-ready text-black text-xs rounded font-semibold">
              OFFICIAL
            </span>
          }
          <span class="px-3 py-1 text-xs rounded font-medium" [ngClass]="getDraftStatusClass(draft)">
            {{ getDraftStatus(draft) }}
          </span>
        </div>
      </div>
      <div class="flex space-x-2">
        @if (showPublishButton && canPublishUtil(draft)) {
          <button
            (click)="onPublish()"
            class="px-4 py-2 bg-action-success text-white rounded hover:bg-action-success-hover text-sm font-medium"
          >
            Publish Draft
          </button>
        }
        @if (showRequestReviewButton && !draft.is_published && !draft.is_approved) {
          <button
            (click)="onRequestReview()"
            [disabled]="requestingReview"
            class="px-4 py-2 bg-action-primary text-white rounded hover:bg-action-primary-hover disabled:bg-action-secondary text-sm font-medium"
          >
            {{ requestingReview ? 'Requesting...' : 'Request Reviewers' }}
          </button>
        }
        @if (canEdit) {
          <button
            (click)="onEdit()"
            class="px-4 py-2 bg-action-primary text-white rounded hover:bg-action-primary-hover text-sm font-medium"
          >
            {{ isEditing() ? 'Cancel Edit' : 'Edit Draft' }}
          </button>
        }
        @if (showApproveButton && canApproveUtil(draft)) {
          <button
            (click)="onApprove()"
            [class]="getActionButtonClass()"
          >
            {{ getActionButtonText() }}
          </button>
        }
        <!-- Version History Button -->
        <button
          (click)="toggleVersionHistory()"
          class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium"
        >
          {{ showVersionHistorySidebar ? 'Hide History' : 'Version History' }}
        </button>
      </div>
    </div>
    
    <!-- Metadata -->
    <div class="flex items-center space-x-4 text-sm text-gray-600 mt-3">
      <span>Author: {{ getUserDisplayName(draft.author) }}</span>
      <span>Created: {{ draft.timestamp | date: "medium" }}</span>
      @if (getApprovers().length > 0) {
        <div class="flex items-center space-x-1">
          <span>Approved by:</span>
          @for (approver of getApprovers(); track approver.id) {
            <app-user-avatar [user]="approver" color="green" size="medium"></app-user-avatar>
          }
        </div>
      }
    </div>

    <!-- Requested Reviewers -->
    @if (draft.requested_reviewers.length > 0) {
      <div class="mt-3">
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-600">Approval Requests:</span>
          <div class="flex space-x-1">
            @for (reviewer of draft.requested_reviewers; track reviewer.id) {
              <app-user-avatar [user]="reviewer" color="purple" size="medium"></app-user-avatar>
            }
          </div>
        </div>
      </div>
    }

    <!-- Approval Status Info -->
    @if (currentUserId && getApprovalReason(draft, currentUserId)) {
      <div class="mt-3 text-sm text-gray-600">
        {{ getApprovalReason(draft, currentUserId) }}
      </div>
    }
  </div>

  <!-- Content Area -->
  <div class="flex-1 overflow-y-auto">
    @if (isEditing()) {
      <!-- Edit Mode -->
      <div class="p-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Definition Content
            </label>
            <app-definition-form
              [content]="editContent"
              [placeholder]="'Enter the definition content here...'"
              (contentChange)="editContent = $event"
            ></app-definition-form>
          </div>

          <div class="flex space-x-3">
            <button
              (click)="onSaveEdit()"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium"
            >
              Save Changes
            </button>
            <button
              (click)="onCancelEdit()"
              class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm font-medium"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    } @else {
      <!-- View Mode -->
      <div class="p-6">
        <div class="prose max-w-none">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Proposed Definition</h3>
          <div class="bg-gray-50 p-4 rounded-lg" [innerHTML]="getProposedDefinitionContent()"></div>
        </div>

        @if (selectedHistoricalDraft) {
          <div class="mt-8 prose max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Historical Draft</h3>
            <div class="bg-purple-50 p-4 rounded-lg" [innerHTML]="selectedHistoricalDraft.content"></div>
            <div class="mt-3 text-sm text-gray-600">
              <p>Author: {{ selectedHistoricalDraft.author.first_name }} {{ selectedHistoricalDraft.author.last_name }}</p>
              <p>Created: {{ selectedHistoricalDraft.timestamp | date: "medium" }}</p>
              @if (selectedHistoricalDraft.is_published) {
                <p>Status: <span class="text-green-600">Published</span></p>
              } @else if (selectedHistoricalDraft.is_approved) {
                <p>Status: <span class="text-blue-600">Approved</span></p>
              } @else {
                <p>Status: <span class="text-orange-600">Draft ({{ selectedHistoricalDraft.approval_count }}/2)</span></p>
              }
            </div>
          </div>
        } @else if (draft.replaces_draft) {
          <div class="mt-8 prose max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Published Version</h3>
            <div class="bg-gray-100 p-4 rounded-lg" [innerHTML]="draft.replaces_draft?.content"></div>
            <div class="mt-3 text-sm text-gray-600">
              <p>Author: {{ draft.replaces_draft?.author?.first_name }} {{ draft.replaces_draft?.author?.last_name }}</p>
              <p>Created: {{ draft.replaces_draft?.timestamp | date: "medium" }}</p>
            </div>
          </div>
        } @else {
          <div class="mt-8 prose max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Published Version</h3>
            <div class="bg-gray-100 p-4 rounded-lg text-gray-500 italic">
              This is a new entry - no published version exists yet.
            </div>
          </div>
        }

        <!-- Comments Section -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Comments</h3>
          @if (isLoadingComments) {
            <div class="text-center text-gray-500 py-4">
              <p>Loading comments...</p>
            </div>
          } @else {
            <app-comment-thread
              [comments]="comments"
              [objectId]="draft.entry.id"
              [contentType]="10"
              (commentAdded)="onCommentAdded($event)"
              (commentResolved)="onCommentResolved($event)"
              (commentUnresolved)="onCommentUnresolved($event)"
            ></app-comment-thread>
          }
        </div>
      </div>
    }
  </div>

  <!-- Version History Sidebar -->
  <app-version-history-sidebar
    [entryId]="(draft?.entry?.id) ?? null"
    [isOpen]="showVersionHistorySidebar"
    (close)="onVersionHistoryClosed()"
    (draftSelected)="onDraftSelected($event)"
  ></app-version-history-sidebar>
} @else {
  <!-- No Selection -->
  <div class="three-panel-detail-empty-state">
    <div class="three-panel-empty-content">
      <div class="three-panel-empty-logo">
        <img src="images/logo.png" alt="Termageddon Logo" />
      </div>
      <h2 class="three-panel-empty-title">Select a Definition</h2>
      <p class="three-panel-empty-subtitle">Choose a definition from the sidebar to review</p>
    </div>
  </div>
}
</div>
