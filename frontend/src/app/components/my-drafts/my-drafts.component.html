<div class="h-full flex bg-white">
  <!-- Left Sidebar -->
  <div class="w-1/3 border-r border-gray-300 flex flex-col">
    <!-- Header -->
    <div class="p-4 border-b border-gray-300">
      <h1 class="text-xl font-bold text-termageddon-gray-dark">My Drafts</h1>
      <p class="text-sm text-gray-600 mt-1">Your draft definitions</p>
    </div>

    <!-- Search -->
    <div class="p-3 border-b border-gray-300">
      <div class="relative">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          placeholder="Search drafts..."
          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-termageddon-accent text-sm"
        />
        @if (searchTerm) {
          <button
            (click)="searchTerm = ''; onSearch()"
            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600"
          >
            âœ•
          </button>
        }
      </div>
    </div>

    <!-- Draft List -->
    <div class="flex-1 overflow-y-auto">
      @if (loading) {
        <div class="p-4 text-center text-gray-500">
          <p>Loading drafts...</p>
        </div>
      } @else if (error) {
        <div class="p-4 text-center text-red-600">
          <p>{{ error }}</p>
          <button
            (click)="loadMyDrafts()"
            class="mt-2 px-3 py-1 bg-termageddon-accent text-white rounded hover:bg-termageddon-primary text-sm"
          >
            Retry
          </button>
        </div>
      } @else if (filteredDrafts.length === 0) {
        <div class="p-4 text-center text-gray-500">
          @if (searchTerm) {
            <p>No drafts found</p>
          } @else {
            <p>No drafts yet</p>
            <p class="text-sm mt-1">Create drafts by editing terms</p>
          }
        </div>
      } @else {
        <div class="space-y-1 p-2">
          @for (draft of filteredDrafts; track draft.id) {
            <div
              (click)="selectDraft(draft)"
              class="p-3 rounded cursor-pointer transition-colors"
              [class.bg-termageddon-blue]="selectedDraft?.id === draft.id"
              [class.text-white]="selectedDraft?.id === draft.id"
              [class.bg-gray-50]="selectedDraft?.id !== draft.id"
              [class.hover:bg-gray-100]="selectedDraft?.id !== draft.id"
            >
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0">
                  <h3 class="font-medium text-sm truncate">
                    {{ draft.entry.term.text }}
                  </h3>
                  <p class="text-xs opacity-75 mt-1">
                    {{ draft.entry.perspective.name }}
                  </p>
                  <div class="flex items-center space-x-2 mt-2">
                    <span
                      class="px-2 py-1 text-xs rounded font-semibold"
                      [ngClass]="getDraftStatusClass(draft)"
                    >
                      {{ getDraftStatus(draft) }}
                    </span>
                    <span class="text-xs opacity-75">
                      {{ draft.timestamp | date: "short" }}
                    </span>
                  </div>
                </div>
                @if (canPublish(draft)) {
                  <button
                    (click)="publishDraft(draft); $event.stopPropagation()"
                    class="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                  >
                    Publish
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Right Content Area -->
  <div class="flex-1 flex flex-col">
    @if (selectedDraft) {
      <!-- Header -->
      <div class="p-4 border-b border-gray-300">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-termageddon-gray-dark">
              {{ selectedDraft.entry.term.text }}
            </h2>
            <div class="flex items-center space-x-2 mt-1">
              <span class="px-2 py-1 bg-termageddon-blue text-white text-xs rounded">
                {{ selectedDraft.entry.perspective.name }}
              </span>
              @if (selectedDraft.entry.is_official) {
                <span class="px-2 py-1 bg-yellow-400 text-black text-xs rounded font-semibold">
                  OFFICIAL
                </span>
              }
              <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs rounded font-medium">
                {{ selectedDraft.approval_count }}/2 Approvals
              </span>
            </div>
          </div>
          <div class="flex space-x-2">
            @if (canPublish(selectedDraft)) {
              <button
                (click)="publishDraft(selectedDraft)"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium"
              >
                Publish Draft
              </button>
            }
            <button
              (click)="requestReviewers()"
              class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium"
            >
              Request Reviewers
            </button>
            <button
              (click)="toggleEditMode(selectedDraft)"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"
            >
              {{ editingDraft?.id === selectedDraft.id ? 'Cancel Edit' : 'Edit Draft' }}
            </button>
          </div>
        </div>
        
        <!-- Metadata -->
        <div class="flex items-center space-x-4 text-sm text-gray-600 mt-3">
          <span>Author: {{ selectedDraft.author.first_name }} {{ selectedDraft.author.last_name }}</span>
          <span>Created: {{ selectedDraft.timestamp | date: "medium" }}</span>
          @if (selectedDraft.approvers.length > 0) {
            <div class="flex items-center space-x-1">
              <span>Approved by:</span>
              @for (approver of selectedDraft.approvers; track approver.id) {
                <div
                  class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-semibold"
                  [title]="approver.first_name + ' ' + approver.last_name"
                >
                  {{ getInitials(approver) }}
                </div>
              }
            </div>
          }
        </div>

        <!-- Requested Reviewers -->
        @if (selectedDraft.requested_reviewers.length > 0) {
          <div class="mt-3">
            <div class="flex items-center space-x-2">
              <span class="text-sm text-gray-600">Approval Requests:</span>
              <div class="flex space-x-1">
                @for (reviewer of selectedDraft.requested_reviewers; track reviewer.id) {
                  <div
                    class="w-6 h-6 rounded-full bg-purple-500 text-white flex items-center justify-center text-xs font-semibold"
                    [title]="reviewer.first_name + ' ' + reviewer.last_name"
                  >
                    {{ getInitials(reviewer) }}
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto">
        @if (editingDraft?.id === selectedDraft.id) {
          <!-- Edit Mode -->
          <div class="p-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Definition Content
                </label>
                <textarea
                  [(ngModel)]="editContent"
                  rows="12"
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-termageddon-accent"
                  placeholder="Enter your definition..."
                ></textarea>
              </div>
              <div class="flex space-x-3">
                <button
                  (click)="saveDraft(selectedDraft)"
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                >
                  Save Changes
                </button>
                <button
                  (click)="cancelEdit()"
                  class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-medium"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        } @else {
          <!-- View Mode -->
          <div class="p-6">
            <div class="prose max-w-none">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Proposed Definition</h3>
              <div class="bg-gray-50 p-4 rounded-lg" [innerHTML]="selectedDraft.content"></div>
            </div>

            @if (selectedDraft.replaces_draft) {
              <div class="mt-8 prose max-w-none">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Published Version</h3>
                <div class="bg-gray-100 p-4 rounded-lg" [innerHTML]="selectedDraft.replaces_draft.content"></div>
                <div class="mt-3 text-sm text-gray-600">
                  <p>Author: {{ selectedDraft.replaces_draft.author.first_name }} {{ selectedDraft.replaces_draft.author.last_name }}</p>
                  <p>Created: {{ selectedDraft.replaces_draft.timestamp | date: "medium" }}</p>
                </div>
              </div>
            } @else {
              <div class="mt-8 prose max-w-none">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Published Version</h3>
                <div class="bg-gray-100 p-4 rounded-lg text-gray-500 italic">
                  This is a new entry - no published version exists yet.
                </div>
              </div>
            }

            <!-- Comments Section -->
            <div class="mt-8">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Comments</h3>
              @if (isLoadingComments) {
                <div class="text-center text-gray-500 py-4">
                  <p>Loading comments...</p>
                </div>
              } @else {
                <app-comment-thread
                  [comments]="comments"
                  [objectId]="selectedDraft.entry.id"
                  [contentType]="1"
                  (commentAdded)="onCommentAdded($event)"
                  (commentResolved)="onCommentResolved($event)"
                  (commentUnresolved)="onCommentUnresolved($event)"
                ></app-comment-thread>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <!-- No Selection -->
      <div class="flex-1 flex items-center justify-center">
        <div class="text-center text-gray-500">
          <h3 class="text-lg font-medium mb-2">Select a Draft</h3>
          <p>Choose a draft from the sidebar to view its details</p>
        </div>
      </div>
    }
  </div>
</div>

<!-- Reviewer Selector Dialog -->
<app-reviewer-selector-dialog
  [isOpen]="showReviewerSelector"
  [users]="allUsers"
  [selectedReviewerIds]="selectedReviewerIds"
  (close)="onReviewerSelectionCancelled()"
  (confirm)="onReviewerSelectionConfirmed($event)"
></app-reviewer-selector-dialog>
