<div class="comment-thread">
  <!-- New Comment Form -->
  <div class="new-comment-form">
    <div class="form-header">
      <h4>Add a Comment</h4>
    </div>
    <div class="form-body">
      <textarea
        [(ngModel)]="newCommentText"
        placeholder="Write your comment here..."
        class="comment-textarea"
        rows="3"
      ></textarea>
      <div class="form-actions">
        <button
          (click)="submitNewComment()"
          [disabled]="!newCommentText.trim() || loading"
          class="btn btn-primary"
        >
          {{ loading ? 'Posting...' : 'Post Comment' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Comments List -->
  <div class="comments-list">
    <div *ngFor="let comment of getTopLevelComments()" class="comment-item">
      <div class="comment-main" [class.resolved]="comment.is_resolved" [class.current-draft-comment]="comment.draft_position === 'current draft'">
        <div class="comment-header">
          <div class="comment-author">
            <app-user-avatar [user]="comment.author" color="blue" size="medium"></app-user-avatar>
            <div class="author-info">
              <span class="author-name">{{ getUserDisplayName(comment.author) }}</span>
              <span class="comment-date">{{ comment.created_at | relativeTime }}</span>
              <!-- Draft Position Indicator -->
              <span
                *ngIf="comment.draft_position"
                class="draft-position-badge"
                [ngClass]="getDraftPositionClass(comment)"
              >
                {{ getDraftPositionText(comment) }}
              </span>
            </div>
            <div class="reply-count" *ngIf="getReplyCount(comment) > 0">
              <button
                (click)="toggleCommentCollapse(comment)"
                class="collapse-btn"
                [title]="isCommentCollapsed(comment) ? 'Show replies' : 'Hide replies'"
              >
                <span class="reply-count-text"
                  >{{ getReplyCount(comment) }}
                  {{ getReplyCount(comment) === 1 ? 'reply' : 'replies' }}</span
                >
                <span class="collapse-icon" [class.collapsed]="isCommentCollapsed(comment)">‚ñº</span>
              </button>
            </div>
          </div>
          <div class="comment-actions">
            <button
              *ngIf="canEdit(comment) && editingComment?.id !== comment.id"
              (click)="startEdit(comment)"
              [disabled]="loading"
              class="btn btn-sm btn-secondary"
            >
              Edit
            </button>
            <button
              *ngIf="canResolve(comment)"
              (click)="comment.is_resolved ? unresolveComment(comment) : resolveComment(comment)"
              [disabled]="loading"
              class="btn btn-sm"
              [ngClass]="comment.is_resolved ? 'btn-warning' : 'btn-success'"
            >
              {{ comment.is_resolved ? 'Unresolve' : 'Resolve' }}
            </button>
            <button
              *ngIf="canReply(comment)"
              (click)="startReply(comment)"
              class="btn btn-sm btn-secondary"
            >
              Reply
            </button>
            <button
              (click)="toggleReaction(comment)"
              class="btn btn-sm btn-secondary reaction-btn"
              [class.reacted]="comment.user_has_reacted"
              [title]="comment.user_has_reacted ? 'Remove thumbs up' : 'Thumbs up'"
            >
              üëç {{ comment.reaction_count || 0 }}
            </button>
          </div>
        </div>

        <div class="comment-content">
          <!-- Edit Mode -->
          <div *ngIf="editingComment?.id === comment.id" class="edit-form">
            <textarea
              [(ngModel)]="editText"
              class="edit-textarea"
              rows="3"
            ></textarea>
            <div class="edit-actions">
              <button
                (click)="submitEdit()"
                [disabled]="!editText.trim() || loading"
                class="btn btn-primary btn-sm"
              >
                {{ loading ? 'Saving...' : 'Save' }}
              </button>
              <button (click)="cancelEdit()" class="btn btn-secondary btn-sm">Cancel</button>
            </div>
          </div>
          <!-- View Mode -->
          <div *ngIf="editingComment?.id !== comment.id" [innerHTML]="formatCommentText(comment)"></div>
        </div>

        <div *ngIf="comment.is_resolved" class="resolved-badge">‚úì Resolved</div>
      </div>

      <!-- Reply Form -->
      <div *ngIf="replyingTo?.id === comment.id" class="reply-form">
        <textarea
          [(ngModel)]="replyText"
          placeholder="Write your reply..."
          class="reply-textarea"
          rows="2"
        ></textarea>
        <div class="reply-actions">
          <button
            (click)="submitReply()"
            [disabled]="!replyText.trim() || loading"
            class="btn btn-primary btn-sm"
          >
            {{ loading ? 'Posting...' : 'Post Reply' }}
          </button>
          <button (click)="cancelReply()" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
      </div>

      <!-- Replies -->
      <div class="replies" *ngIf="getReplies(comment).length > 0 && !isCommentCollapsed(comment)">
        <div *ngFor="let reply of getReplies(comment)" class="reply-item">
          <div class="reply-main">
            <div class="reply-header">
              <div class="reply-author">
                <app-user-avatar [user]="reply.author" color="blue" size="small"></app-user-avatar>
                <div class="author-info">
                  <span class="author-name">{{ getUserDisplayName(reply.author) }}</span>
                  <span class="reply-date">{{ reply.created_at | relativeTime }}</span>
                </div>
              </div>
            </div>

            <div class="reply-content">
              <!-- Edit Mode for Replies -->
              <div *ngIf="editingComment?.id === reply.id" class="edit-form">
                <textarea
                  [(ngModel)]="editText"
                  class="edit-textarea"
                  rows="2"
                ></textarea>
                <div class="edit-actions">
                  <button
                    (click)="submitEdit()"
                    [disabled]="!editText.trim() || loading"
                    class="btn btn-primary btn-sm"
                  >
                    {{ loading ? 'Saving...' : 'Save' }}
                  </button>
                  <button (click)="cancelEdit()" class="btn btn-secondary btn-sm">Cancel</button>
                </div>
              </div>
              <!-- View Mode for Replies -->
              <div *ngIf="editingComment?.id !== reply.id" [innerHTML]="formatCommentText(reply)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Comments -->
    <div *ngIf="getTopLevelComments().length === 0" class="no-comments">
      <p>No comments yet. Be the first to comment!</p>
    </div>
  </div>
</div>
