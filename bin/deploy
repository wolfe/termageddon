#!/bin/bash
set -ex

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="${SCRIPT_DIR}/.."

AUTO_APPROVE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -y)
      AUTO_APPROVE="-auto-approve"
      shift
      ;;
    *)
      ENVIRONMENT=$1
      shift
      ;;
  esac
done

[ -z "${ENVIRONMENT}" ] && echo "Usage: $0 [-y] <environment>" && exit 1

TERRAFORM_DIR="${PROJECT_ROOT}/terraform/aws/${ENVIRONMENT}"
TFVARS_FILE="config/termageddon-${ENVIRONMENT}.tfvars"
TAG=$(git rev-parse --short HEAD 2>/dev/null || echo "latest")

echo "=== Deploying ${ENVIRONMENT}: ${TAG} ==="

cd "${TERRAFORM_DIR}"
[ -f .env ] && source .env

terraform apply ${AUTO_APPROVE} -var-file="${TFVARS_FILE}" -var="image_tag=${TAG}"

echo "✓ Deployed: ${TAG}"

# Wait for health endpoint to return expected version
HEALTH_URL="https://termageddon-${ENVIRONMENT}.analyzere.net/health/"
[ "${ENVIRONMENT}" = "prod" ] && HEALTH_URL="https://termageddon.analyzere.net/health/"

set +x
echo "Waiting for new version to be deployed"
MAX_ATTEMPTS=60
ATTEMPT=0

while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
  ATTEMPT=$((ATTEMPT + 1))

  if RESPONSE=$(curl -sf "${HEALTH_URL}" 2>/dev/null); then
    DEPLOYED_VERSION=$(echo "${RESPONSE}" | jq -r '.version' 2>/dev/null || echo "unknown")

    if [ "${DEPLOYED_VERSION}" = "${TAG}" ]; then
      echo ""
      echo "✓ Health check passed: version ${DEPLOYED_VERSION}"
      exit 0
    fi
  fi

  echo -n "."
  sleep 5
done

echo ""
echo "✗ Timeout waiting for version ${TAG} to deploy"
exit 1
