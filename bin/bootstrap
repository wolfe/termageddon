#!/bin/bash

# Termageddon Bootstrap Script
# Sets up shared environment and checks preconditions
# This script should be sourced, not executed: source ./bin/bootstrap

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

# Export paths for use by calling scripts
export SCRIPT_DIR PROJECT_ROOT BACKEND_DIR FRONTEND_DIR

# Verify directories exist
if [ ! -d "$BACKEND_DIR" ]; then
    print_error "Backend directory not found at: $BACKEND_DIR"
    return 1 2>/dev/null || exit 1
fi

if [ ! -d "$FRONTEND_DIR" ]; then
    print_error "Frontend directory not found at: $FRONTEND_DIR"
    return 1 2>/dev/null || exit 1
fi

# Initialize pyenv if available
if command -v pyenv > /dev/null 2>&1; then
    eval "$(pyenv init - bash)"
    print_status "Initialized pyenv"
else
    print_error "pyenv is not installed or not on PATH."
    print_error "This project requires pyenv to manage Python versions."
    print_error "Install pyenv: https://github.com/pyenv/pyenv#installation"
    return 1 2>/dev/null || exit 1
fi

# Change to backend directory to pick up .python-version
cd "$BACKEND_DIR" || {
    print_error "Failed to change to backend directory: $BACKEND_DIR"
    return 1 2>/dev/null || exit 1
}

# Verify Python version (pyenv shims will handle python command)
if ! command -v python > /dev/null 2>&1; then
    print_error "python executable not found on PATH."
    print_error "Ensure pyenv is properly configured and a Python version is set:"
    echo "  pyenv install 3.13.1   # if not already installed"
    echo "  pyenv local 3.13.1"
    return 1 2>/dev/null || exit 1
fi

PYTHON_VERSION_OUTPUT=$(python - << 'PY'
import sys
print(".".join(map(str, sys.version_info[:3])))
PY
)

PY_MAJOR=$(echo "$PYTHON_VERSION_OUTPUT" | cut -d. -f1)
PY_MINOR=$(echo "$PYTHON_VERSION_OUTPUT" | cut -d. -f2)

if [ "$PY_MAJOR" -lt 3 ] || { [ "$PY_MAJOR" -eq 3 ] && [ "$PY_MINOR" -lt 13 ]; }; then
    print_error "Detected Python version $PYTHON_VERSION_OUTPUT, but Python 3.13+ is required for the backend (Django 5.x)."
    print_error "From the backend directory, run:"
    echo "  pyenv install 3.13.1   # if not already installed"
    echo "  pyenv local 3.13.1"
    return 1 2>/dev/null || exit 1
fi

PYTHON_PATH=$(pyenv which python 2>/dev/null || echo "python")
print_status "Using Python $PYTHON_VERSION_OUTPUT from pyenv: $PYTHON_PATH"

# Export Python path for use by calling scripts
export PYTHON_PATH PYTHON_VERSION_OUTPUT
