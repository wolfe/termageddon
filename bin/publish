#!/bin/bash
set -ex

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
BACKEND_DIR="${SCRIPT_DIR}/../backend"
FRONTEND_DIR="${SCRIPT_DIR}/../frontend"

ECR_REGISTRY="753029624111.dkr.ecr.us-east-2.amazonaws.com"
ECR_REPO="termageddon-dev-backend"
AWS_REGION="us-east-2"

TAG=$(git rev-parse --short HEAD 2>/dev/null || echo "latest")
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

echo "=== Publishing tag: ${TAG} ==="

cd "${FRONTEND_DIR}"
npm run build

rm -rf "${BACKEND_DIR}/target"
cp -r dist/frontend/browser "${BACKEND_DIR}/target"

aws ecr get-login-password --region ${AWS_REGION} | \
  docker login --username AWS --password-stdin ${ECR_REGISTRY}

cd "${BACKEND_DIR}"
docker build \
  --platform linux/amd64 \
  --build-arg BUILD_VERSION=${TAG} \
  --build-arg BUILD_TIME=${BUILD_TIME} \
  -t termageddon-backend .

docker tag termageddon-backend:latest ${ECR_REGISTRY}/${ECR_REPO}:${TAG}
docker push ${ECR_REGISTRY}/${ECR_REPO}:${TAG}

echo "âœ“ Published: ${ECR_REGISTRY}/${ECR_REPO}:${TAG}"
echo "To deploy: ./bin/deploy dev"
