#!/bin/bash

# Termageddon Demo Script
# Launches backend and frontend servers with test data

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Function to check if port is in use
port_in_use() {
    lsof -i:$1 > /dev/null 2>&1
    return $?
}

# Function to kill process on port
kill_port() {
    local port=$1
    local pid=$(lsof -t -i:$port 2>/dev/null)
    if [ -n "$pid" ]; then
        print_warning "Killing existing process on port $port (PID: $pid)"
        kill $pid 2>/dev/null
        sleep 2
    fi
}

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

print_status "Starting Termageddon Demo..."
print_status "Project root: $PROJECT_ROOT"

# Check if backend directory exists
if [ ! -d "$BACKEND_DIR" ]; then
    print_error "Backend directory not found at: $BACKEND_DIR"
    exit 1
fi

# Check if frontend directory exists
if [ ! -d "$FRONTEND_DIR" ]; then
    print_error "Frontend directory not found at: $FRONTEND_DIR"
    exit 1
fi

# Check and kill if ports are already in use
if port_in_use 8000; then
    kill_port 8000
fi

if port_in_use 4200; then
    kill_port 4200
fi

# Setup backend
print_status "Setting up backend..."
cd "$BACKEND_DIR"

# Remove old venv if it exists but is broken
if [ -d "venv" ] && [ ! -f "venv/bin/python3" ]; then
    print_status "Removing broken virtual environment..."
    rm -rf venv
fi

# Create virtual environment if it doesn't exist
if [ ! -d "venv" ]; then
    print_status "Creating virtual environment..."
    python3 -m venv venv
    if [ $? -ne 0 ]; then
        print_error "Failed to create virtual environment"
        exit 1
    fi
fi

# Activate virtual environment
source venv/bin/activate
if [ $? -ne 0 ]; then
    print_error "Failed to activate virtual environment"
    exit 1
fi

# Install dependencies
print_status "Installing backend dependencies..."
pip install -q -r requirements.txt
if [ $? -ne 0 ]; then
    print_error "Failed to install backend dependencies"
    exit 1
fi

# Check if database exists, if not run migrations
if [ ! -f "db.sqlite3" ]; then
    print_status "Running database migrations..."
    python manage.py migrate
    if [ $? -ne 0 ]; then
        print_error "Failed to run migrations"
        exit 1
    fi

    # Load test data for new database
    print_status "Loading test data..."
    python manage.py load_test_data
    if [ $? -ne 0 ]; then
        print_error "Failed to load test data"
        exit 1
    fi
else
    print_status "Database already exists, skipping migrations and test data"
fi

# Collect static files (needed for Django admin)
print_status "Collecting static files..."
python manage.py collectstatic --noinput
if [ $? -ne 0 ]; then
    print_error "Failed to collect static files"
    exit 1
fi

# Start backend server in background
# Set DEBUG=True for development to enable static file serving
print_status "Starting backend server..."
DEBUG=True python manage.py runserver 2>&1 &
BACKEND_PID=$!

# Wait for backend to be ready
print_status "Waiting for backend to start..."
sleep 3

# Check if backend is still running
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    print_error "Backend server failed to start"
    exit 1
fi

# Setup and start frontend
print_status "Setting up frontend..."
cd "$FRONTEND_DIR"

# Always install dependencies to ensure they're up to date
print_status "Installing frontend dependencies..."
npm install
if [ $? -ne 0 ]; then
    print_error "Failed to install frontend dependencies"
    kill $BACKEND_PID
    exit 1
fi

# Start frontend server in foreground temporarily to see errors
print_status "Starting frontend server..."
npm start 2>&1 &
FRONTEND_PID=$!

# Wait for frontend to be ready
print_status "Waiting for frontend to start..."
sleep 10

# Check if frontend is still running
if ! kill -0 $FRONTEND_PID 2>/dev/null; then
    print_error "Frontend server failed to start"
    print_error "Check the output above for npm/Angular errors"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

# Open browsers
print_success "Opening browsers..."
if command -v open > /dev/null 2>&1; then
    # macOS
    open "http://localhost:4200" 2>/dev/null
    open "http://localhost:8000/admin" 2>/dev/null
elif command -v xdg-open > /dev/null 2>&1; then
    # Linux
    xdg-open "http://localhost:4200" 2>/dev/null
    xdg-open "http://localhost:8000/admin" 2>/dev/null
elif command -v start > /dev/null 2>&1; then
    # Windows
    start "http://localhost:4200"
    start "http://localhost:8000/admin"
else
    print_warning "Could not detect browser launcher"
    print_status "Please open manually:"
    print_status "  Frontend: http://localhost:4200"
    print_status "  Admin: http://localhost:8000/admin"
fi

print_success "Demo is running!"
print_status "Frontend: http://localhost:4200"
print_status "Backend: http://localhost:8000"
print_status "Admin: http://localhost:8000/admin"
print_status ""
print_status "Login credentials:"
print_status "  Admin: admin / admin"
print_status "  Test Users: <username> / ImABird"
print_status "    - mariacarter (Perspective Curator)"
print_status "    - bencarter (Perspective Curator)"
print_status "    - sofiarossi (Perspective Curator)"
print_status "    - leoschmidt (Perspective Curator)"
print_status "    - kenjitanaka (Perspective Curator)"
print_status "    - aishakhan, samuelgreene, ivanpetrov, chloedubois"
print_status ""
print_status "Press Ctrl+C to stop servers"

# Cleanup function
cleanup() {
    print_status "Stopping servers..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    print_success "Servers stopped"
    exit 0
}

# Set up trap for Ctrl+C
trap cleanup INT TERM

# Wait for user interrupt
wait
