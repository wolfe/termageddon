#!/bin/bash

# Termageddon Demo Script
# Launches backend and frontend servers with test data

# Source bootstrap script for shared setup
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/bootstrap" || exit 1

print_status "Starting Termageddon Demo..."
print_status "Project root: $PROJECT_ROOT"

# Function to check if port is in use
port_in_use() {
    lsof -i:$1 > /dev/null 2>&1
    return $?
}

# Function to kill process on port
kill_port() {
    local port=$1
    local pid=$(lsof -t -i:$port 2>/dev/null)
    if [ -n "$pid" ]; then
        print_warning "Killing existing process on port $port (PID: $pid)"
        kill $pid 2>/dev/null
        sleep 2
    fi
}

# Check and kill if ports are already in use
if port_in_use 8000; then
    kill_port 8000
fi

if port_in_use 4200; then
    kill_port 4200
fi

# Setup backend (we're already in BACKEND_DIR from bootstrap)
print_status "Setting up backend..."

# Install any missing backend dependencies (managed via pyenv Python)
print_status "Checking backend dependencies (via pip)..."
python -m pip install -q -r requirements.txt || {
    print_warning "Some packages may already be installed or unavailable"
}

# Wipe database on every run for clean demo
print_status "Wiping existing database..."
rm -f db.sqlite3

# Create migrations for any model changes
print_status "Creating migrations for model changes..."
python manage.py makemigrations || {
    print_error "Failed to create migrations"
    exit 1
}

# Run migrations to create fresh database
print_status "Running database migrations..."
python manage.py migrate || {
    print_error "Failed to run migrations"
    exit 1
}
python manage.py migrate || {
    print_error "Failed to re-run migrations"
    exit 1
}

# Load test data
print_status "Loading test data..."
python manage.py load_test_data || {
    print_error "Failed to load test data"
    exit 1
}

# Collect static files (needed for Django admin)
print_status "Collecting static files..."
python manage.py collectstatic --noinput || {
    print_error "Failed to collect static files"
    exit 1
}

# Start backend server in background
# Set DEBUG=True for development to enable static file serving
print_status "Starting backend server..."
DEBUG=True python manage.py runserver 2>&1 &
BACKEND_PID=$!

# Wait for backend to be ready
print_status "Waiting for backend to start..."
sleep 3

# Check if backend is still running
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    print_error "Backend server failed to start"
    exit 1
fi

# Setup and start frontend
print_status "Setting up frontend..."
cd "$FRONTEND_DIR"

# Always install dependencies to ensure they're up to date
print_status "Installing frontend dependencies..."
npm install --legacy-peer-deps || {
    print_error "Failed to install frontend dependencies"
    kill $BACKEND_PID 2>/dev/null
    exit 1
}

# Start frontend server in foreground temporarily to see errors
print_status "Starting frontend server..."
npm start 2>&1 &
FRONTEND_PID=$!

# Wait for frontend to be ready
print_status "Waiting for frontend to start..."
sleep 10

# Check if frontend is still running
if ! kill -0 $FRONTEND_PID 2>/dev/null; then
    print_error "Frontend server failed to start"
    print_error "Check the output above for npm/Angular errors"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

# Open browser
print_success "Opening browser..."
if command -v open > /dev/null 2>&1; then
    # macOS
    open "http://localhost:4200" 2>/dev/null
elif command -v xdg-open > /dev/null 2>&1; then
    # Linux
    xdg-open "http://localhost:4200" 2>/dev/null
elif command -v start > /dev/null 2>&1; then
    # Windows
    start "http://localhost:4200"
else
    print_warning "Could not detect browser launcher"
    print_status "Please open manually: http://localhost:4200"
fi

print_success "Demo is running!"
print_status "Frontend: http://localhost:4200"
print_status "Admin: http://localhost:4200/admin (accessible from frontend)"
print_status ""
print_status "Login credentials:"
print_status "  Admin: admin / admin"
print_status "  Test Users: <username> / ImABird"
print_status "    - mariacarter (Perspective Curator)"
print_status "    - bencarter (Perspective Curator)"
print_status "    - sofiarossi (Perspective Curator)"
print_status "    - leoschmidt (Perspective Curator)"
print_status "    - kenjitanaka (Perspective Curator)"
print_status "    - aishakhan, samuelgreene, ivanpetrov, chloedubois"
print_status ""
print_status "Press Ctrl+C to stop servers"

# Cleanup function
cleanup() {
    print_status "Stopping servers..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    print_success "Servers stopped"
    exit 0
}

# Set up trap for Ctrl+C
trap cleanup INT TERM

# Wait for user interrupt
wait
